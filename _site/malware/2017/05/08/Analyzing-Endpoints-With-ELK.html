<!DOCTYPE html>
<html>    
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Analyzing Endpoints With ELK</title>
  <meta name="description" content="In this post I will cover my analysis setup in regards to how I have mine configured to capture and consume Sysmon(Windows Logs), Packetbeat, Bro and Procmon...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://localhost:4000/malware/2017/05/08/Analyzing-Endpoints-With-ELK.html">
  <link rel="alternate" type="application/atom+xml" title="The Negative.Zone" href="http://localhost:4000/feed.xml" />
  <script src="/scripts/jquery-3.2.1.min.js"></script>
  <script src="/scripts/pithy.js"></script>
</head>


  <body>
    <header class="header">
	<div class="header-container">
		<div class="nav">
			
				<li>
					<a href="/index.html">home</a>
				</li>			
			
			
				<li>
					<a href="/archive.html">archive</a>
				</li>			
			
			
				<li>
					<a href="/category.html">category</a>
				</li>			
			
			
				<li>
					<a href="/about.html">about</a>
				</li>			
			
		</div>
		<div class="description"> The Crossroads of Infinity </div>		
		<ul class="social-links">
			<li>
				<a href="https://github.com/Kvetch" title="Github">
					<img width="19px" height="19px" src="/images/github.png"/>
				</a>
			</li>
			<li>
				<a href="/feed.xml" title="RSS">
					<img width="19px" height="19px" src="/images/rss.png"/>
				</a>
			</li>
			<li>
				<a href="https://twitter.com/NBaronian" title="Twitter">
					<img width="19px" height="19px" src="/images/twitter.png"/>
				</a>
			</li>
		</ul>		
	</div>
</header>

    <br>
    <div class="page-content">
      <div class="wrapper">
        <div class="post">
  <br>
  <header class="post-header">
    <h1 class="post-title">Analyzing Endpoints With ELK</h1>
    <p class="post-meta">May 8, 2017</p>
  </header>

  <article class="post-content">
    <p>In this post I will cover my analysis setup in regards to how I have mine configured to capture and consume Sysmon(Windows Logs), Packetbeat, Bro and Procmon.  Everyone loves the SysInternals Suite.  It comes with an amazing array of analysis tools that have all held the test of time.  As with most folks who using the tool suite, <a href="https://technet.microsoft.com/en-us/sysinternals/processmonitor.aspx" title="Procmon" target="_blank">Process Monitor</a> is likely in their top 3 favorites.  Those that use Procmon regularly likely have their favorite filters and perhaps tools.  Many folks use tools like <a href="https://github.com/Rurik/Noriben" target="_blank">Noriben</a> to get quick hits when running malicious binaries.  Noriben is an amazing script that allows you to run Noriben, run your malicious executable and then stop Noriben and review the parsed Procmon output.  As always, there’s more than one way to skin a <a href="http://www.worldwidewords.org/qa/qa-mor1.htm" target="_blank">cat</a> and because I like using ELK for filtering out some of my analysis, I thought I would take a crack at parsing Procmon with Logstash.  Everyone has different setups, so I won’t touch on how you execute Procmon (vmrun), filters you may want to keep local to Procmon or where you save the output, although I will mention saving to a location like a VM shared folder so Logstash or Beats can read is likely ideal.</p>

<p>First things first, my analysis VMs have Sysmon installed, as well as <a href="https://www.elastic.co/downloads/beats/winlogbeat" target="_blank">Winlogbeat</a> and <a href="https://www.elastic.co/downloads/beats/packetbeat" target="_blank">Packetbeat</a>.  Even though I am running Packetbeat, I also run Bro for some additional traffic details.  I won’t cover how to install these because it is pretty dead simple.  I will share my ELK configuration files though.  As for Procmon, it offers multiple output formats, PML, XML and CSV.  Knowing that XML or CSV would likely be the best suited for an ELK setup, I tested playing with both and while XML is doable, it seems to present a lot of unnecessary overhead and Logstash parsing because the XML output is largely filled with data we don’t necessarily need.  For this post I will highlight how to use CSV output.  If you still want to play with parsing the XML output from Procmon feel free to utilize/tweak the following <a href="https://gist.github.com/Kvetch/35ecafd9f0519b261da0dfe78376079e" target="_blank">gist</a>.  I find the XML parsing to not be overly reliable, so to me it I landed on leaning on the CSV output.</p>

<p>Before I get into how Procmon, I will cover the easier configurations.  Getting Logstash to process incoming Beats data is <a href="https://gist.github.com/Kvetch/f155b71475ae52d1f10d7ef207315ab6" target="_blank">simple</a>.  Just tell Logstash to accept input from the Beats service kicking data out to port 5044 and then send it to Elastic on 9200 and voilà.  Packetbeats will send data directly to Logstash and if you configured Winlogbeat to consume Sysmon logs, you should be good to go.</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>input <span class="o">{</span>
  beats <span class="o">{</span>
    port <span class="o">=</span>&gt; 5044
  <span class="o">}</span>
<span class="o">}</span>
output <span class="o">{</span>
  elasticsearch <span class="o">{</span>
    hosts <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"http://localhost:9200"</span><span class="o">]</span>
    index <span class="o">=</span>&gt; <span class="s2">"%{[@metadata][beat]}-%{+YYYY.MM.dd}"</span>
    document_type <span class="o">=</span>&gt; <span class="s2">"%{[@metadata][type]}"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Capturing full pcaps is another element I won’t cover here but usually when I am performing analysis in a VM, I capture traffic on my Host and then run Bro against the pcap.  I know there are a handful of decent tutorials covering how to parse Bro logs into ELK but since Bro can automatically parse into JSON, I find this method the cleanest and easiest.  To enable JSON output simply add the following to be default or execute bro manually to parse out to JSON like so</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>Under bro/share/bro/site/local.bro add
  @tuning/json-logs
run
  broctl config
  broctl install
Then just run Bro against a pcap
  bro -r some.pcap
or <span class="k">if </span>you want to just tell Bro to parse to JSON when you need it run the following:
  bro -r some.pcap /opt/local/share/bro/policy/tuning/json-logs.bro
</code></pre>
</div>
<p>From here you can tweak your output into Elastic however you see fit but I’ve found the following <a href="https://gist.github.com/Kvetch/6ddf203e2fd462e8d6a62f64a80326dd" target="_blank">config</a> works nicely for me.  I will note, I am using the de_dot plugin to assist here.  In short, you would capture your pcap and tell Bro to parse the pcap into a JSON log and Logstash will pick it up using something like the following:</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>input <span class="o">{</span>
  file <span class="o">{</span>
  		<span class="nb">type</span> <span class="o">=</span>&gt; <span class="s2">"bro_logs"</span>
        path <span class="o">=</span>&gt; <span class="s2">"/Analysis/Pcaps/*.log"</span>
        start_position <span class="o">=</span>&gt; beginning
        codec <span class="o">=</span>&gt; json
    	sincedb_path <span class="o">=</span>&gt; <span class="s2">"/var/log/.bro_sincedb"</span>
       <span class="o">}</span>
<span class="o">}</span>

filter <span class="o">{</span>
  date <span class="o">{</span>
    match <span class="o">=</span>&gt; <span class="o">[</span> <span class="s2">"ts"</span>, <span class="s2">"UNIX"</span> <span class="o">]</span>
    target <span class="o">=</span>&gt; <span class="s2">"@timestamp"</span>
    remove_field <span class="o">=</span>&gt; <span class="o">[</span> <span class="s2">"ts"</span> <span class="o">]</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">[</span>log_path] <span class="o">==</span> <span class="s2">"weird"</span> <span class="o">{</span>
    de_dot <span class="o">{</span>
      fields <span class="o">=</span>&gt; <span class="o">[</span>
        <span class="s2">"id.orig_p"</span>,
        <span class="s2">"id.resp_p"</span>
      <span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">[</span>log_path] <span class="o">==</span> <span class="s2">"software"</span> <span class="o">{</span>
    de_dot <span class="o">{</span>
      fields <span class="o">=</span>&gt; <span class="o">[</span>
        <span class="s2">"version.major"</span>,
        <span class="s2">"version.minor"</span>,
        <span class="s2">"version.minor2"</span>,
        <span class="s2">"version.minor3"</span>,
        <span class="s2">"version.addl"</span>
      <span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">[</span>log_path] <span class="o">==</span> <span class="s2">"x509"</span> <span class="o">{</span>
    de_dot <span class="o">{</span>
      fields <span class="o">=</span>&gt; <span class="o">[</span>
        <span class="s2">"certificate.version"</span>,
        <span class="s2">"certificate.serial"</span>,
        <span class="s2">"certificate.subject"</span>,
        <span class="s2">"certificate.issuer"</span>,
        <span class="s2">"certificate.exponent"</span>,
        <span class="s2">"certificate.curve"</span>,
        <span class="s2">"sans.dns"</span>,
        <span class="s2">"basic_constraints.ca"</span>
      <span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">[</span>log_path] <span class="o">==</span> <span class="s2">"intel"</span> <span class="o">{</span>
    de_dot <span class="o">{</span>
      fields <span class="o">=</span>&gt; <span class="o">[</span>
        <span class="s2">"seen.indicator"</span>,
        <span class="s2">"seen.where"</span>,
        <span class="s2">"seen.node"</span>
      <span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>
  mutate <span class="o">{</span>
    rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"id.orig_p"</span>, <span class="s2">"src_port"</span><span class="o">]</span>
    rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"id.resp_p"</span>, <span class="s2">"dst_port"</span><span class="o">]</span>
    rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"id.orig_h"</span>, <span class="s2">"src_ip"</span><span class="o">]</span>
    rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"id.resp_h"</span>, <span class="s2">"dst_ip"</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>


output <span class="o">{</span>
  elasticsearch <span class="o">{</span>
    hosts <span class="o">=</span>&gt; <span class="s2">"localhost"</span>
    index <span class="o">=</span>&gt; <span class="s2">"bro"</span>
    document_type <span class="o">=</span>&gt; <span class="s2">"Bro"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>
<p>Since those inputs are in JSON format there isn’t much to them besides tweaking to your liking.  Dealing with Procmon’s output takes a hair more tweaking but not much.  So let’s break down the config into chunks.  Starting with the Input, we need to tell Logstash to look for the Procmon output file csv.</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>input <span class="o">{</span>
  file <span class="o">{</span>
    path <span class="o">=</span>&gt; <span class="s2">"/SomeDir/LogFile.CSV"</span>
    start_position <span class="o">=</span>&gt; <span class="s2">"beginning"</span>
    sincedb_path <span class="o">=</span>&gt; <span class="s2">"/dev/null"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>
<p>Next we need to set the CSV filter.  This part is completely configurable based on your liking.  Procmon produces its CSV columns based on what the GUI window is displaying column wise and dependent on what outputs you are viewing.  For example, I have my Procmon configured to show the following and in this order.  You would adjust this based on what you find useful.</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>filter <span class="o">{</span>
  csv <span class="o">{</span>
    separator <span class="o">=</span>&gt; <span class="s2">","</span>
    <span class="c">############ CHANGE ###################</span>
    columns <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time of Day"</span>,<span class="s2">"Process Name"</span>,<span class="s2">"PID"</span>,<span class="s2">"Operation"</span>,<span class="s2">"Path"</span>,<span class="s2">"Result"</span>,<span class="s2">"Detail"</span>,<span class="s2">"Event Class"</span>,<span class="s2">"Sequence"</span>,<span class="s2">"Image Path"</span>,<span class="s2">"Company"</span>,<span class="s2">"Description"</span>,<span class="s2">"Version"</span>,<span class="s2">"User"</span>,<span class="s2">"Session"</span>,<span class="s2">"Command Line"</span>,<span class="s2">"TID"</span>,<span class="s2">"Virtualized"</span>,<span class="s2">"Integrity"</span>,<span class="s2">"Category"</span>,<span class="s2">"Parent PID"</span><span class="o">]</span>
    <span class="c">############## ME ####################</span>
  <span class="o">}</span>
</code></pre>
</div>
<p>Next, for good measure we need to convert a few field to their appropriate type.  I also recommend removing the message field to remove unnecessary clutter.</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>  mutate <span class="o">{</span>
    convert <span class="o">=</span>&gt; <span class="o">{</span>
      <span class="s2">"PID"</span>       <span class="o">=</span>&gt; <span class="s2">"integer"</span>
      <span class="s2">"TID"</span>  <span class="o">=</span>&gt; <span class="s2">"integer"</span>
      <span class="s2">"Parent PID"</span> <span class="o">=</span>&gt; <span class="s2">"integer"</span>
      <span class="s2">"Virtualized"</span>  <span class="o">=</span>&gt; <span class="s2">"boolean"</span>
      <span class="s2">"Session"</span> <span class="o">=</span>&gt; <span class="s2">"integer"</span>
      <span class="s2">"Sequence"</span> <span class="o">=</span>&gt; <span class="s2">"integer"</span>
      <span class="s2">"Duration"</span> <span class="o">=</span>&gt; <span class="s2">"float"</span>
    <span class="o">}</span>
    remove_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s1">'message'</span><span class="o">]</span>
  <span class="o">}</span>    
</code></pre>
</div>
<p>Next thing we need to do is get Procmon’s multiple timestamps to work with Elastic’s <a href="http://www.joda.org/joda-time/apidocs/org/joda/time/format/ISODateTimeFormat.html#dateOptionalTimeParser--" target="_blank">Joda</a> millisecond timestamps.  So we look for the string ‘PM’ in the ‘Time of Day’ field, we remove the last 7 digits to make it work within millisecond time.  Then we take the ‘Date &amp; Time’ field and we split it using spaces as the delimiter.  Now we add a new field, we call Time and grab the first element from the split and the newly trimmed ‘Time of Day’ and add the string ‘PM’.  We then do the same for AM.  Lastly we tell Logstash how it should interpret the Time field and we then set that to the @timestamp field.</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>  <span class="k">if</span> <span class="s2">"PM"</span> <span class="k">in</span> <span class="o">[</span>Time of Day]
  <span class="o">{</span>
    mutate <span class="o">{</span>
      gsub <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time of Day"</span>, <span class="s2">".{7}$"</span>, <span class="s2">""</span><span class="o">]</span>
      split <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Date &amp; Time"</span>, <span class="s2">" "</span><span class="o">]</span>
      add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time"</span>, <span class="s2">"%{[Date &amp; Time][0]} %{[Time of Day]} PM"</span><span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="s2">"AM"</span> <span class="k">in</span> <span class="o">[</span>Time of Day]
  <span class="o">{</span>
    mutate <span class="o">{</span>
      gsub <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time of Day"</span>, <span class="s2">".{7}$"</span>, <span class="s2">""</span><span class="o">]</span>
      split <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Date &amp; Time"</span>, <span class="s2">" "</span><span class="o">]</span>
      add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time"</span>, <span class="s2">"%{[Date &amp; Time][0]} %{[Time of Day]} AM"</span><span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>
  date <span class="o">{</span>
    match <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time"</span>, <span class="s2">"MM/dd/YYYY hh:mm:ss.SSS aa"</span><span class="o">]</span>
    target <span class="o">=</span>&gt; <span class="s2">"@timestamp"</span>
  <span class="o">}</span>
</code></pre>
</div>
<p>Next we need to clean up and adjust the Network Operation events to make it easier for us to query on.  First, we filter on Network Events and we split the Path because Procmon lists network source and destination addresses on one line.  Then we reference the Operation, trigger on if it says Send or Receive.  We then designate the appropriate array element to either the source IP or destination IP depending on the Operation in play.</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>  <span class="k">if</span> <span class="o">[</span>Event Class] <span class="o">==</span> <span class="s2">"Network"</span>
  <span class="o">{</span>
    mutate <span class="o">{</span>
      split <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Path"</span>, <span class="s2">"-&gt;"</span><span class="o">]</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="s2">"Send"</span> <span class="k">in</span> <span class="o">[</span>Operation]
      <span class="o">{</span>
        mutate <span class="o">{</span>
          add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"src_ip"</span>, <span class="s2">"%{[Path][0]}"</span><span class="o">]</span>
          add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"dst_ip"</span>, <span class="s2">"%{[Path][1]}"</span><span class="o">]</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="k">if</span> <span class="s2">"Receive"</span> <span class="k">in</span> <span class="o">[</span>Operation]
      <span class="o">{</span>
        mutate <span class="o">{</span>
          add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"dst_ip"</span>, <span class="s2">"%{[Path][0]}"</span><span class="o">]</span>
          add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"src_ip"</span>, <span class="s2">"%{[Path][1]}"</span><span class="o">]</span>
        <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre>
</div>
<p>Lastly, we remove fields no longer needed and send the output to elastic.</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>  mutate <span class="o">{</span>
    remove_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s1">'Time of Day'</span>, <span class="s1">'Date &amp; Time'</span>, <span class="s1">'Time'</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>

output
<span class="o">{</span>
    elasticsearch
    <span class="o">{</span>
        hosts <span class="o">=</span>&gt; <span class="s2">"localhost"</span>
        index <span class="o">=</span>&gt; <span class="s2">"logstash-"</span>
        document_type <span class="o">=</span>&gt; <span class="s2">"Procmon"</span>
    <span class="o">}</span>
stdout <span class="o">{}</span>
<span class="o">}</span>
</code></pre>
</div>
<p>It will likely help if you push some mappings or reference some mappings within your Logstash config.  I find at a minimum listing the src and dst IP as ip is worthwhile.</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="o">{</span>
  <span class="s2">"mappings"</span>: <span class="o">{</span>
    <span class="s2">"procmon"</span>: <span class="o">{</span>
      <span class="s2">"properties"</span>: <span class="o">{</span>
        <span class="s2">"Version"</span>: <span class="o">{</span>
          <span class="s2">"type"</span>: <span class="s2">"text"</span>
        <span class="o">}</span>,
        <span class="s2">"ip_src"</span>: <span class="o">{</span>
          <span class="s2">"type"</span>: <span class="s2">"ip"</span>
        <span class="o">}</span>,
        <span class="s2">"ip_dst"</span>: <span class="o">{</span>
          <span class="s2">"type"</span>: <span class="s2">"ip"</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>
<p>Okay, so now that we have the individual Logstash confs we like, we should set them all up into one conf.  Here is an <a href="https://gist.github.com/Kvetch/ecd9cfeef4d7488a896e32af95c0d606" target="_blank">example</a></p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>input <span class="o">{</span>
  beats <span class="o">{</span>
    <span class="nb">type</span> <span class="o">=</span>&gt; <span class="s2">"beats"</span>
    port <span class="o">=</span>&gt; 5044
    <span class="c">#codec =&gt; json</span>
  <span class="o">}</span>
  file <span class="o">{</span>
    <span class="nb">type</span> <span class="o">=</span>&gt; <span class="s2">"procmon"</span>
    <span class="c">############ CHANGE ###################</span>
    path <span class="o">=</span>&gt; <span class="s2">"/ELK/Analysis/LogFile.CSV"</span>
    <span class="c">############## ME ####################</span>
    start_position <span class="o">=</span>&gt; <span class="s2">"beginning"</span>
    sincedb_path <span class="o">=</span>&gt; <span class="s2">"/dev/null"</span>
  <span class="o">}</span>
  file <span class="o">{</span>
    <span class="nb">type</span> <span class="o">=</span>&gt; <span class="s2">"Bro"</span>
    <span class="c">############ CHANGE ###################</span>
    path <span class="o">=</span>&gt; <span class="s2">"/ELK/Analysis/Pcap/*.log"</span>
    <span class="c">############## ME ####################</span>
    start_position <span class="o">=</span>&gt; beginning
    codec <span class="o">=</span>&gt; json
    sincedb_path <span class="o">=</span>&gt; <span class="s2">"/dev/null"</span>
  <span class="o">}</span>
<span class="o">}</span>

filter <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span><span class="nb">type</span><span class="o">]</span> <span class="o">==</span> <span class="s2">"procmon"</span> <span class="o">{</span>
    csv <span class="o">{</span>
      separator <span class="o">=</span>&gt; <span class="s2">","</span>
      <span class="c">############ CHANGE ###################</span>
      columns <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time of Day"</span>,<span class="s2">"Process Name"</span>,<span class="s2">"PID"</span>,<span class="s2">"Operation"</span>,<span class="s2">"Path"</span>,<span class="s2">"Result"</span>,<span class="s2">"Detail"</span>,<span class="s2">"Event Class"</span>,<span class="s2">"Sequence"</span>,<span class="s2">"Image Path"</span>,<span class="s2">"Company"</span>,<span class="s2">"Description"</span>,<span class="s2">"Version"</span>,<span class="s2">"User"</span>,<span class="s2">"Session"</span>,<span class="s2">"Command Line"</span>,<span class="s2">"TID"</span>,<span class="s2">"Virtualized"</span>,<span class="s2">"Integrity"</span>,<span class="s2">"Category"</span>,<span class="s2">"Parent PID"</span><span class="o">]</span>
      <span class="c">############## ME ####################</span>
    <span class="o">}</span>
    mutate <span class="o">{</span>
      convert <span class="o">=</span>&gt; <span class="o">{</span>
        <span class="s2">"PID"</span>       <span class="o">=</span>&gt; <span class="s2">"integer"</span>
        <span class="s2">"TID"</span>  <span class="o">=</span>&gt; <span class="s2">"integer"</span>
        <span class="s2">"Parent PID"</span> <span class="o">=</span>&gt; <span class="s2">"integer"</span>
        <span class="s2">"Virtualized"</span>  <span class="o">=</span>&gt; <span class="s2">"boolean"</span>
        <span class="s2">"Session"</span> <span class="o">=</span>&gt; <span class="s2">"integer"</span>
        <span class="s2">"Sequence"</span> <span class="o">=</span>&gt; <span class="s2">"integer"</span>
        <span class="s2">"Duration"</span> <span class="o">=</span>&gt; <span class="s2">"float"</span>
      <span class="o">}</span>
      remove_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s1">'message'</span><span class="o">]</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="s2">"PM"</span> <span class="k">in</span> <span class="o">[</span>Time of Day]
    <span class="o">{</span>
      mutate <span class="o">{</span>
        gsub <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time of Day"</span>, <span class="s2">".{7}$"</span>, <span class="s2">""</span><span class="o">]</span>
        split <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Date &amp; Time"</span>, <span class="s2">" "</span><span class="o">]</span>
        add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time"</span>, <span class="s2">"%{[Date &amp; Time][0]} %{[Time of Day]} PM"</span><span class="o">]</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="s2">"AM"</span> <span class="k">in</span> <span class="o">[</span>Time of Day]
    <span class="o">{</span>
      mutate <span class="o">{</span>
        gsub <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time of Day"</span>, <span class="s2">".{7}$"</span>, <span class="s2">""</span><span class="o">]</span>
        split <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Date &amp; Time"</span>, <span class="s2">" "</span><span class="o">]</span>
        add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time"</span>, <span class="s2">"%{[Date &amp; Time][0]} %{[Time of Day]} AM"</span><span class="o">]</span>
      <span class="o">}</span>
    <span class="o">}</span>
    date <span class="o">{</span>
      match <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Time"</span>, <span class="s2">"MM/dd/YYYY hh:mm:ss.SSS aa"</span><span class="o">]</span>
      target <span class="o">=</span>&gt; <span class="s2">"@timestamp"</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">[</span>Event Class] <span class="o">==</span> <span class="s2">"Network"</span>
    <span class="o">{</span>
      mutate <span class="o">{</span>
        split <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"Path"</span>, <span class="s2">"-&gt;"</span><span class="o">]</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="s2">"Send"</span> <span class="k">in</span> <span class="o">[</span>Operation]
        <span class="o">{</span>
          mutate <span class="o">{</span>
            add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"src_ip"</span>, <span class="s2">"%{[Path][0]}"</span><span class="o">]</span>
            add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"dst_ip"</span>, <span class="s2">"%{[Path][1]}"</span><span class="o">]</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="k">if</span> <span class="s2">"Receive"</span> <span class="k">in</span> <span class="o">[</span>Operation]
        <span class="o">{</span>
          mutate <span class="o">{</span>
            add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"dst_ip"</span>, <span class="s2">"%{[Path][0]}"</span><span class="o">]</span>
            add_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"src_ip"</span>, <span class="s2">"%{[Path][1]}"</span><span class="o">]</span>
          <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    mutate <span class="o">{</span>
      remove_field <span class="o">=</span>&gt; <span class="o">[</span><span class="s1">'Time of Day'</span>, <span class="s1">'Date &amp; Time'</span>, <span class="s1">'Time'</span><span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>


  <span class="k">if</span> <span class="o">[</span><span class="nb">type</span><span class="o">]</span> <span class="o">==</span> <span class="s2">"bro-logs"</span> <span class="o">{</span>
    date <span class="o">{</span>
      match <span class="o">=</span>&gt; <span class="o">[</span> <span class="s2">"ts"</span>, <span class="s2">"UNIX"</span> <span class="o">]</span>
      target <span class="o">=</span>&gt; <span class="s2">"@timestamp"</span>
      remove_field <span class="o">=</span>&gt; <span class="o">[</span> <span class="s2">"ts"</span> <span class="o">]</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">[</span>log_path] <span class="o">==</span> <span class="s2">"weird"</span> <span class="o">{</span>
      de_dot <span class="o">{</span>
        fields <span class="o">=</span>&gt; <span class="o">[</span>
          <span class="s2">"id.orig_p"</span>,
          <span class="s2">"id.resp_p"</span>
        <span class="o">]</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">[</span>log_path] <span class="o">==</span> <span class="s2">"software"</span> <span class="o">{</span>
      de_dot <span class="o">{</span>
        fields <span class="o">=</span>&gt; <span class="o">[</span>
          <span class="s2">"version.major"</span>,
          <span class="s2">"version.minor"</span>,
          <span class="s2">"version.minor2"</span>,
          <span class="s2">"version.minor3"</span>,
          <span class="s2">"version.addl"</span>
        <span class="o">]</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">[</span>log_path] <span class="o">==</span> <span class="s2">"x509"</span> <span class="o">{</span>
      de_dot <span class="o">{</span>
        fields <span class="o">=</span>&gt; <span class="o">[</span>
          <span class="s2">"certificate.version"</span>,
          <span class="s2">"certificate.serial"</span>,
          <span class="s2">"certificate.subject"</span>,
          <span class="s2">"certificate.issuer"</span>,
          <span class="s2">"certificate.exponent"</span>,
          <span class="s2">"certificate.curve"</span>,
          <span class="s2">"sans.dns"</span>,
          <span class="s2">"basic_constraints.ca"</span>
        <span class="o">]</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">[</span>log_path] <span class="o">==</span> <span class="s2">"intel"</span> <span class="o">{</span>
      de_dot <span class="o">{</span>
        fields <span class="o">=</span>&gt; <span class="o">[</span>
          <span class="s2">"seen.indicator"</span>,
          <span class="s2">"seen.where"</span>,
          <span class="s2">"seen.node"</span>
        <span class="o">]</span>
      <span class="o">}</span>
    <span class="o">}</span>
    mutate <span class="o">{</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"id.orig_p"</span>, <span class="s2">"src_port"</span><span class="o">]</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"id.resp_p"</span>, <span class="s2">"dst_port"</span><span class="o">]</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"id.orig_h"</span>, <span class="s2">"src_ip"</span><span class="o">]</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"id.resp_h"</span>, <span class="s2">"dst_ip"</span><span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">if</span> <span class="o">[</span><span class="nb">type</span><span class="o">]</span> <span class="o">==</span> <span class="s2">"beats"</span> <span class="o">{</span>
    mutate <span class="o">{</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"client_ip"</span>, <span class="s2">"src_ip"</span><span class="o">]</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"source.ip"</span>, <span class="s2">"src_ip"</span><span class="o">]</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"client_port"</span>, <span class="s2">"src_port"</span><span class="o">]</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"source.port"</span>, <span class="s2">"src_port"</span><span class="o">]</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"dest.port"</span>, <span class="s2">"dst_port"</span><span class="o">]</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"port"</span>, <span class="s2">"dst_port"</span><span class="o">]</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"dest.ip"</span>, <span class="s2">"dst_ip"</span><span class="o">]</span>
      rename <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"ip"</span>, <span class="s2">"dst_ip"</span><span class="o">]</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>


output
<span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span><span class="nb">type</span><span class="o">]</span> <span class="o">==</span> <span class="s2">"procmon"</span> <span class="o">{</span>
    elasticsearch <span class="o">{</span>
      hosts <span class="o">=</span>&gt; <span class="s2">"localhost"</span>
      index <span class="o">=</span>&gt; <span class="s2">"procmon"</span>
      document_type <span class="o">=</span>&gt; <span class="s2">"Procmon"</span>
      template <span class="o">=</span>&gt; <span class="s2">"/Applications/ELK/confs/procmon.mappings"</span>
      template_overwrite <span class="o">=</span>&gt; <span class="nb">true</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">if</span> <span class="o">[</span><span class="nb">type</span><span class="o">]</span> <span class="o">==</span> <span class="s2">"Bro"</span> <span class="o">{</span>
    elasticsearch <span class="o">{</span>
      hosts <span class="o">=</span>&gt; <span class="s2">"localhost"</span>
      index <span class="o">=</span>&gt; <span class="s2">"bro"</span>
      document_type <span class="o">=</span>&gt; <span class="s2">"Bro"</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">else</span> <span class="o">{</span>
    elasticsearch <span class="o">{</span>
      hosts <span class="o">=</span>&gt; <span class="s2">"localhost"</span>
      index <span class="o">=</span>&gt; <span class="s2">"beats"</span>
      document_type <span class="o">=</span>&gt; <span class="s2">"Beats"</span>
    <span class="o">}</span>
  <span class="o">}</span>
stdout <span class="o">{}</span>
<span class="o">}</span>
</code></pre>
</div>
<p>If you want to add something like VirusTotal or SpamHaus lookups to your src or dst IPs?  Add a mutate filter to your Logstash conf like so,</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>mutate <span class="o">{</span>
  add_field <span class="o">=</span>&gt; <span class="o">[</span> <span class="s2">"Spamhaus_lookup"</span>, <span class="s2">"http://www.spamhaus.org/query/bl?ip=%{dst_ip}"</span> <span class="o">]</span>
<span class="o">}</span>
</code></pre>
</div>
<p>Okay so now you have a conf that handles Sysmon via Windows Event Log consumption from Winlogbeat, Packet information from Packetbeat, Pcap parsing from Bro output, as well as Procmon parsing.  How do you use it all?  Your sequence would likely look something like the following:
If not already started, you start your ELK stack with your Logstash config looking for Bro and Procmon output.
You start your packet capturing for Bro (manually vmrun or script automation), for example you could use tcpdump, tshark or whatever floats your boat.  I usually use VMware for no good reason other than it only a Ctrl+R away in my shell history</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo /Applications/VMware<span class="se">\ </span>Fusion.app/Contents/Library/vmnet-sniffer -e -w blah.pcap vmnet8
</code></pre>
</div>
<p>Then on your VM or whatever, you start Procmon(can also be started automatically) with whatever config you like (just put the columns you select in your Logstash config), run your evil or suspected evil binary.  Stop Procmon and save it as a CSV to the dir Logstash is monitoring.
Then you run stop sniffing and run Bro against the pcap</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>sudo bro -r blah.pcap /opt/local/share/bro/policy/tuning/json-logs.bro
</code></pre>
</div>
<p>From there you jump into Kibana and start your analysis.</p>

<p>Tools like Noriben and Procmon filters can help you speed up your analysis.  Luckily many of these filters and logical queries are easy to do in Kibana.  For example, you can easily build a whitelist of hashes, Registry paths, processes or network traffic.  You can also perform some logical queries, like only show me the Process Create, SetDispositionInformationFile, Create File, RegCreateKey, RegSetKey, or TCP/UDP events that were marked as SUCCESS?
You could run queries like such and then start building repeatable search reports</p>
<div class="language-shell highlighter-rouge"><pre class="highlight"><code>Result:SUCCESS AND Operation:CreateFile<span class="k">*</span> AND Detail:Created AND !Detail:Opened AND !Path:<span class="o">(</span><span class="se">\"</span>ProgramData<span class="se">\\\\</span>winlogbeat<span class="se">\\\\\"</span> OR <span class="se">\"</span>Windows<span class="se">\\\\</span>SoftwareDistribution<span class="se">\\\\</span>WuRedir<span class="se">\"</span> OR <span class="se">\"</span>Windows<span class="se">\\\\</span>SoftwareDistribution<span class="se">\\\\</span>SelfUpdate<span class="se">\"</span><span class="o">)</span>
<span class="c"># OR Maybe</span>
_exists_:dest.ip AND _exists_:dest.port AND !dest.port:<span class="o">(</span>445 OR 138 OR 137<span class="o">)</span> AND !dest.ip:<span class="o">(</span>172.<span class="k">*</span> and 224.<span class="k">*</span> and 255.<span class="k">*</span> and 239.<span class="k">*</span><span class="o">)</span>
<span class="c"># Or Maybe something like</span>
proto:udp AND id.resp_p:53 AND _exists_:query AND _exists_:answers AND !query:<span class="o">(</span>safebrowsing.google.com OR <span class="k">*</span>.gstatic.com <span class="k">*</span>.googleapis.com <span class="k">*</span>.googleusercontent.com OR ns-cloud-d1.googledomains.com OR <span class="k">*</span>.msftncsi.com OR <span class="k">*</span>.adobe.com<span class="k">*</span> OR <span class="k">*</span>.microsoft.com<span class="k">*</span> OR <span class="k">*</span>.doubleclick.net OR <span class="k">*</span>.windowsupdate.nsatc.net OR oscp.verisign.com OR <span class="k">*</span>.windowsupdate.com OR <span class="k">*</span>.google.com<span class="o">)</span> AND !answers:<span class="o">(</span><span class="k">*</span>.googleusercontent.com OR <span class="k">*</span>.facebook.com OR <span class="k">*</span>.msftncsi.com OR <span class="k">*</span>.adobe.com OR <span class="k">*</span>.doubleclick.net OR <span class="k">*</span>.windowsupdate.nsatc.net OR safebrowsing.google.com OR <span class="k">*</span>.fbcdn.net OR <span class="k">*</span>.google.com OR <span class="k">*</span>.akamaitechnologies.com<span class="o">)</span>
</code></pre>
</div>
<p><img src="http://localhost:4000/images/Bro-Query.png" alt="Bro Query Example" />
<img src="http://localhost:4000/images/CreateFileReport.png" alt="CreateFile Success Report" />
Once you start tweaking your queries to match your preferences you can starting building dashboards to show you event output like tools like Noriben or CaptureBAT.
<img src="http://localhost:4000/images/Dashboard-Example.png" alt="Dashboard Example Snippet" />
If others are using something similar, I would love to hear from them and if you have dashboards or reports you are willing to share, please give me a shout or post them in the comments.  Thanks!</p>

  </article>
	<div class="ds-thread" data-thread-key=/malware/2017/05/08/Analyzing Endpoints With ELK data-title=Analyzing Endpoints With ELK data-url=The Crossroads of Infinity//malware/2017/05/08/Analyzing-Endpoints-With-ELK.html></div>
</div>

      </div>
    </div>
    
    <footer class="footer">
  <div id="gotop">^</div>
  <br>
  
  <div class="post-author text-center">
  	<img src="http://localhost:4000/images/ShoePhone.gif" alt="Kvetch's photo" class="post-avatar" style="width:150px;height:150px;"/>
  	<h3>
  		By <span itemprop="name" class="fn"><a href="/about" title="About Kvetch" itemprop="url">Kvetch</a></span>
  	</h3>
  	<p>One more guy occasionally blogging about stuff, usually DFIR focused.</p>
  </div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'thenegative-zone'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  
  
      <div id="disqus_thread"></div><!-- /#disqus_thread -->
  
  <br>
	@2017 Nick Baronian - Kvetch
  <script>
    var _gaq = _gaq || [];
    var pluginUrl =
   '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
    _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
    _gaq.push(['_setAccount', 'UA-91327667-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
</footer>

    
  </body>

</html>
